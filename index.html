<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sport Lock</title>
<style>
body { font-family: Arial, sans-serif; text-align:center; margin:20px; }
.circle { width: 150px; height: 150px; border-radius: 50%; border: 10px solid #ccc; margin: 20px auto; position: relative; }
.progress { position: absolute; top:0; left:0; width:100%; height:100%; border-radius: 50%; clip: rect(0px, 150px, 150px, 75px); background: #4caf50; transform: rotate(0deg); transform-origin: center center; }
.inner { width: 120px; height: 120px; background:#fff; border-radius:50%; position:absolute; top:15px; left:15px; line-height:120px; font-size:24px; }
button { margin: 5px; padding: 10px 20px; font-size: 16px; }
#status { margin-top: 20px; font-size: 18px; }

.tabs { margin:20px auto; display:flex; justify-content:center; gap:10px; }
.tab { padding:10px 20px; cursor:pointer; background:#eee; border-radius:5px; }
.tab.active { background:#4caf50; color:white; }

.tab-content { display:none; margin-top:20px; }
.tab-content.active { display:block; }
label { display:block; margin:5px 0; }
input, select { padding:5px; width:100px; }
</style>
</head>
<body>

<h1>Sport Lock</h1>

<div class="tabs">
  <div class="tab active" data-tab="daily">Objectifs JournÃ©e</div>
  <div class="tab" data-tab="week">Objectifs Semaine</div>
</div>

<div class="tab-content active" id="daily">
  <h3>Objectifs JournÃ©e</h3>
  <div id="daily-sports"></div>
  <button onclick="addSport('daily')">Ajouter un sport</button>
</div>

<div class="tab-content" id="week">
  <h3>Objectifs Semaine</h3>
  <div id="week-sports"></div>
  <button onclick="addSport('week')">Ajouter un sport</button>
</div>

<div class="circle">
  <div class="progress" id="progress"></div>
  <div class="inner" id="percent">0%</div>
</div>

<div id="status">Sport non terminÃ© ðŸ”’</div>
<button onclick="unlockTV()">DÃ©bloquer TV</button>
<button onclick="lockTV()">Bloquer TV</button>

<script>
/* Tabs */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

/* Stockage des objectifs */
function getGoals(type) {
  const data = JSON.parse(localStorage.getItem(type)) || [];
  return data;
}

function saveGoals(type, data) {
  localStorage.setItem(type, JSON.stringify(data));
  updateProgressFromWorker();
}

/* Ajouter un sport */
function addSport(type) {
  const container = document.getElementById(type+'-sports');
  const div = document.createElement('div');
  div.innerHTML = `
    <select class="sport">
      <option value="course">Course Ã  pied</option>
      <option value="velo">VÃ©lo</option>
      <option value="marche">Marche</option>
      <option value="muscu">Musculation</option>
    </select>
    <input type="number" class="distance" placeholder="Distance ou min" value="0">
    <button onclick="removeSport(this)">Supprimer</button>
  `;
  container.appendChild(div);
}

/* Supprimer sport */
function removeSport(btn) {
  btn.parentElement.remove();
}

/* RÃ©cupÃ©rer les objectifs du formulaire */
function readGoals(type) {
  const container = document.getElementById(type+'-sports');
  const data = [];
  container.querySelectorAll('div').forEach(div=>{
    const sport = div.querySelector('.sport').value;
    const dist = parseFloat(div.querySelector('.distance').value) || 0;
    data.push({sport, distance: dist});
  });
  saveGoals(type, data);
}

/* Boutons TV */
function unlockTV() { document.getElementById('status').textContent="TV dÃ©bloquÃ©e âœ…"; }
function lockTV() { document.getElementById('status').textContent="Sport non terminÃ© ðŸ”’"; }

/* Cercle */
function setProgress(percent) {
  const deg = percent*3.6;
  document.getElementById('progress').style.transform=`rotate(${deg}deg)`;
  document.getElementById('percent').textContent=percent+"%";
  if(percent>=100) document.getElementById('status').textContent="Sport terminÃ© âœ…";
  else document.getElementById('status').textContent="Sport non terminÃ© ðŸ”’";
}

/* Fetch Worker Strava et calcul automatique */
function updateProgressFromWorker() {
  const dailyGoals = getGoals('daily');
  const weeklyGoals = getGoals('week');

  fetch("https://sport-lock-strava.thomas-dutoyat.workers.dev/")
    .then(res=>res.json())
    .then(data=>{
      // On fait la somme des distances par exemple
      const dailyTarget = dailyGoals.reduce((sum,g)=>sum+g.distance,0)||20;
      const weekTarget = weeklyGoals.reduce((sum,g)=>sum+g.distance,0)||80;
      const percentDay = Math.min(Math.round((data.today/dailyTarget)*100),100);
      const percentWeek = Math.min(Math.round((data.week/weekTarget)*100),100);
      setProgress(percentDay);
      console.log("Jour:", percentDay,"% / Semaine:", percentWeek,"%");
    }).catch(err=>console.error(err));
}

/* Initialisation */
window.onload=function(){
  ['daily','week'].forEach(type=>{
    const goals = getGoals(type);
    const container = document.getElementById(type+'-sports');
    goals.forEach(g=>{
      const div=document.createElement('div');
      div.innerHTML=`
        <select class="sport">
          <option value="course"${g.sport==='course'?' selected':''}>Course Ã  pied</option>
          <option value="velo"${g.sport==='velo'?' selected':''}>VÃ©lo</option>
          <option value="marche"${g.sport==='marche'?' selected':''}>Marche</option>
          <option value="muscu"${g.sport==='muscu'?' selected':''}>Musculation</option>
        </select>
        <input type="number" class="distance" value="${g.distance}">
        <button onclick="removeSport(this)">Supprimer</button>
      `;
      container.appendChild(div);
    });
  });
  updateProgressFromWorker();
};
</script>

</body>
</html>
